---
title: "Data cleaning, tidy data"
output: html_notebook
---


## Clean data:
- one data, one variable
- one row per observation
- data and type matches
- same name for same categories
- clean factors, if necessary

Exercise

1. Clean up the following dataset, using base R:
messy_data.xlsx

```{r}
Sys.setlocale("LC_TIME", "English")

messy_data <- read.delim("../data/messy_data.txt", stringsAsFactors = F)

messy_data$Patient.id <- toupper(messy_data$Patient.id)
messy_data$Patient.id <- gsub("TCGA ", "TCGA_", messy_data$Patient.id)
messy_data <- messy_data[1:18,]
messy_data <- messy_data[,colnames(messy_data)!="X"]



summary(messy_data)
#help: https://www.stat.berkeley.edu/~s133/dates.html
messy_data$Date.of.surgery <- as.Date(messy_data$Date.of.surgery, format="%d-%b-%y")
messy_data$Date.of.birth <- as.Date(as.Date( messy_data$Date.of.birth, format="%d/%m/%Y"))
messy_data$Date.of.diagnosis <- as.Date(messy_data$Date.of.diagnosis, format="%d/%m/%Y")
messy_data$Time.of.death <- as.Date(messy_data$Time.of.death, format="%d-%b-%y")


Age <- difftime(messy_data$Date.of.diagnosis,messy_data$Date.of.birth, units = "days")
Age <- round(Age/365, digits = 0)
table(Age,messy_data$Age)
messy_data$Age <- Age

messy_data$Gender
messy_data$Status

table(messy_data$Status, messy_data$Censor)
messy_data$Identifier <- NULL
messy_data$Classification <- NULL

summary(messy_data$enzyme.level)
boxplot(messy_data$enzyme.level)
messy_data$enzyme.level[messy_data$enzyme.level>600] <- NA
boxplot(messy_data$enzyme.level)
table(messy_data$Histological.subtype)
messy_data$Histological.subtype <- gsub(" ", "", messy_data$Histological.subtype)
table(messy_data$Histological.subtype)

table(messy_data$MUC1)

messy_data$MUC1 <- factor(messy_data$MUC1, levels = c("0", "0bis1", "1", "2", "3"))
messy_data$N <- gsub("(T[[:digit:]])(N[[:digit:]])(M[[:digit:]])", "\\2", messy_data$TNM)
messy_data$M <- gsub("(T[[:digit:]])(N[[:digit:]])(M[[:digit:]])", "\\3", messy_data$TNM)
messy_data$TNM <- NULL

```



## Tidy data

by Hadley Wickham
- long over wide format
- data is in tibbles
- tidyverse offers various functions to easily manipulate the data
- new concept: piping.

Examples:


```{r}
library(dplyr)
library(tidyr)
library(tibble)
library(readxl)
data(mtcars)

mtcars <- as_tibble(rownames_to_column(mtcars))

filtered <-mtcars %>%
  filter(gear<5) 

filtered %>% 
  group_by(carb) %>%
  summarise(qsec_mean=mean(qsec))

#it is possible to combine as many steps as needed without saving it in a separate object

mtcars %>%
  filter(gear<5) %>%
  group_by(carb) %>%
  summarise(sum_drat=sum(drat), mean_drat=mean(drat))

mtcars %>%
  mutate(cyl_2=if_else(cyl==8, 7, cyl))


mtcars %>%
  mutate(gear=gear-1)

mtcars %>%
  pivot_longer(-rowname, names_to = "name", values_to = "values")

```


2. Clean up the following dataset, using as much tidyverse as possible:
messy_data.xlsx

```{r}

messy_data <- read_excel("../data/messy_data.xlsx",
col_types = c("text", "numeric", "text",
"date", "date", "date", "text", "text",
"text", "date", "numeric", "text",
"text", "numeric", "text", "text",
"text"), n_max = 20)


messy_data <- messy_data %>%
  select_all(~gsub(" ", ".", .)) %>% 
  mutate(Patient.id= toupper(Patient.id)) %>%
  mutate(Patient.id= gsub(" ", "_", Patient.id), 
         Identifier=NULL, 
         Classification=NULL, 
         Age=round(difftime(Date.of.diagnosis,Date.of.birth, units = "days")/365, digits = 0), 
         Histological.subtype = gsub(" ", "", Histological.subtype), 
         MUC1 = factor(MUC1, levels = c("0", "0bis1", "1", "2", "3")), 
         N=gsub("(T[[:digit:]])(N[[:digit:]])(M[[:digit:]])", "\\2", TNM), 
         M= gsub("(T[[:digit:]])(N[[:digit:]])(M[[:digit:]])", "\\3", TNM), TNM = NULL)


```


## Merging data

`merge()` funtction from base R
`join()` function from tidyvers

```{r}

band_members %>% full_join(band_instruments)

merge(band_members, band_instruments, by="name", all=T, sort=F)

```

